<!DOCTYPE html>
<html>
  <head>
    <title>7 - MFA</title>
    <base href="../">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="wysiwiki/wysiwiki.css" type="text/css" />
    <link rel="stylesheet" href="style.css" type="text/css" />    
    <link rel="shortcut icon" href="favicon.ico" />    
    <script src="wysiwiki/wysiwiki.js"></script>
  </head>
  <body>
    <header><a rel='author' href='https://www.canterbury.ac.nz/nzilbb/'><img src='nzilbb.svg' alt='Te KƒÅhui Roro Reo | The New Zealand Institute of Language, Brain and Behaviour' title='üÑØ NZILBB'></a></header>
    <div id="main">
      <aside></aside>
      <article>
<h2>7 - MFA</h2>
 <p>The Montreal Forced Aligner (MFA) is a 3rd-party tool developed by Michael McAuliffe and others that can use words with phonemic transcriptions, and the corresponding audio, to force-align words and phones; i.e. determine the start and end time of each speech sound within each word, and thus the start/end times of the words.</p>
 <p>The annotator can work in two modes:</p>
 <ul>
  <li><i>Train and Align</i> - acoustic models are trained on the data you want to align, which can be in any language as long as you have a pronunciation dictionary for it.</li>
  <li><i>Pre-trained Models/Dictionaries</i> - pre-trained models and pronunciation dictionaries are supplied by the Montreal Forced Aligner and used for forced alignment. Languages for which dictionaries are available include:
 <ul>
  <li>English</li>
  <li>French</li>
  <li>German</li>
  <li>Brazilian Portuguese</li>
  <li>Spanish</li>
  <li>Catalan</li></ul></li></ul>
 <p>As the data we have is in English, we will use the <i>Pre-trained Models/Dictionaries</i> approach in this exercise.</p>
 <p>In this exercise you will</p>
 <ul>
  <li>install the MFA Layer Manager,</li>
  <li>force-align the speech of all of the participants in your database, and</li>
  <li>check and manually correct the alignments.</li></ul>
 <p><i><strong>NB</strong>: In this exercise, you will set up Praat Integration in your web browser. There is currently no Praat integration support for Microsoft's Edge' browser, so if you normally use 'Edge' on Windows, you may need to swap to another browser for this exercise - e.g. Microsoft Internet Explorer, Google Chrome, or Mozilla Firefox.</i></p>
<hr>
 <p>MFA is a 3rd-party tool (<a target="_blank" rel="noopener noreferrer" href="https://montrealcorpustools.github.io/Montreal-Forced-Aligner">https://montrealcorpustools.github.io/Montreal-Forced-Aligner/</a>) that LaBB-CAT integrates with via a Layer Manager module. MFA is not included as part of LaBB-CAT, and so it must be installed on the server you have installed LaBB-CAT on before you can integrate LaBB-CAT with it.</p>
 <p>If MFA has not been installed already, please follow the following steps, depending on the operatings system of your LaBB-CAT server:</p>
<h3>Linux</h3>
 <p>To install the Montreal Forced Aligner on Linux systems for all users, so that your web server can access it if required:</p>
 <ol>
  <li>Download Miniconda:
  <br><code>wget https://repo.anaconda.com/miniconda/Miniconda3-py38\_4.10.3-Linux-x86\_64.sh</code></li>
  <li>Start the installer:
  <br><code>sudo bash Miniconda3-py38\_4.10.3-Linux-x86\_64.sh</code></li>
  <li>When asked the location to install Miniconda, use:
  <br><code>/opt/conda</code></li>
  <li>When asked whether the installer should initialize Miniconda, this is unnecessary so you can respond <code>no</code></li>
  <li>Change ownership of the conda files):
  <br><code>sudo chown -R $USERNAME:$USERNAME /opt/conda</code></li>
  <li>Make conda accessible to all users (so you web server can access MFA):
  <br><code>chmod -R go-w /opt/conda</code>
  <br><code>chmod -R go+rX /opt/conda</code></li>
  <li>Install the Montreal Forced Aligner
  <br><code>/opt/conda/bin/conda create -n aligner -c conda-forge montreal-forced-aligner</code></li></ol>
<h3>Windows</h3>
 <p>To install the Montreal Forced Aligner on Windows systems for all users, so that your web server can access it if required:</p>
 <ol>
  <li>Download the Miniconda installer:&nbsp;&nbsp;&nbsp;
  <br><a target="_blank" rel="noopener noreferrer" href="https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe">https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe</a></li>
  <li>Start the installer by double-clicking it.</li>
  <li>When asked, select the ‚ÄúInstall for all users‚Äù option. This will install conda somewhere like
  <br><i>C:\ProgramData\Miniconda3</i></li>
  <li>When asked, tick the <i>add to PATH</i> option.</li>
  <li>Install the Montreal Forced Aligner by specifying a path to the environment
  <br><code>conda create -c conda-forge -p C:\ProgramData\Miniconda3\envs\aligner montreal-forced-aligner</code></li></ol>
<h3>Docker Container</h3>
 <p>If your LaBB-CAT server is installed in a Docker Container, it can download and install Miniconda and MFA itself, as part of the process of installing the MFA Manager (below)</p>
 <p>Once MFA has been installed, you have to install the MFA Manager, which is the LaBB-CAT module that provides MFA with all the data it needs, and then saves to alignments MFA produces back to your database.</p>
 <ol>
  <li>Click the <i>layer managers</i> menu option.</li>
  <li>Click the <i>List of layer managers that are not yet installed</i> link.</li>
  <li>Find MFA Manager in the list, and click its <i>Install</i> button and then click <i>Install</i> again.
  <br>
  <br>As long as MFA has been installed for all users, you should see a box that's already filled in with the location that MFA was installed to in the <i>Path to MFA</i> box.
  <br>
  <br>If the <i>Path to MFA</i> box is empty and there's an <i>Attempt to Install MFA</i> button, click the button, and LaBB-CAT will try to install MFA on the server for you. This process can take a few minutes, and the <i>Configure</i> button will be disabled until it's finished.</li>
  <li>Click <i>Configure</i> to continue the layer manager installation.
  <br>You will see a window open with some information about integrating with MFA, including the information you've already read above.</li>
  <li>Now you need to add a <i>phrase layer</i> for the MFA configuration:
 <ul>
  <li><strong>Layer ID:</strong> mfa</li>
  <li><strong>Type:</strong> <i>Text</i></li>
  <li><strong>Alignment:</strong> <i>Intervals</i></li>
  <li><strong>Manager:</strong> <i>MFA Manager</i></li>
  <li><strong>Generate:</strong> <i>always</i></li>
  <li><strong>Description:</strong> MFA alignment time</li></ul></li>
  <li>When you configure the layer, set the following options:
 <ul>
  <li><strong>Dictionary Name:</strong> <i>english_mfa</i></li>
  <li><strong>Pretrained Acoustic Models:</strong> <i>english_mfa</i></li>
  <li>The rest of the options can be left as their default values.
  <br>
  <br>If you're curious about what the configuration options do, hover your mouse over each option to see a ‚Äòtool tip‚Äô that describes what the option is for.</li></ul></li>
  <li>Click <i>Set Parameters</i>
  <br>We will not click <i>Regenerate</i> to force-align the whole corpus just yet. We need to tweak a few other settings, and then align a single participant's speech.
  <br>
  <br>When forced-alignment is done, the resulting aligned phones are saved on the <i>segment</i> layer. By default, this has it's type set to <i>Phonological</i>, which assumes that the phoneme symbols will be those defined by the CELEX DISC encoding. However, MFA uses its own phoneme symbols, which are different from the CELEX DISC ones.&nbsp;
  <br>To make later processing easier, we're going to change the type of the <i>segment</i> layer to <i>Text</i>, and let LaBB-CAT know what the possible phoneme labels are.</li>
  <li>Click the <i>segment layers</i> menu option.
  <br>You will see a single layer listed, called <i>segment</i>.</li>
  <li>Change the <i>Type</i> of the <i>segment</i> layer to <i>Text</i>.</li>
  <li>Click <i>Save</i>.
  <br>A new button appears with a tag <img src="./forced-alignment/tag.svg"> icon - if you hover the mouse over this button, you'll see it's for setting <i>Valid labels</i>.</li>
  <li>Click the <i>Valid labels</i> button.
  <br>You will see a page that allows you to add a list of possible labels.
  <br>But we don't know what the valid labels are yet. The labels used by MFA depend on the dictionary/models selected when defining the layer. The details for all dictionaries are in <a target="_blank" rel="noopener noreferrer" href="https://mfa-models.readthedocs.io/en/latest/dictionary/index.html#dictionary">MFA Models documentation</a>.</li>
  <li>Open the <a target="_blank" rel="noopener noreferrer" href="https://mfa-models.readthedocs.io/en/latest/dictionary/English/English%20MFA%20dictionary%20v2_0_0.html#English%20MFA%20dictionary%20v2_0_0">MFA Models documentation for <i>english_mfa</i></a>.
  <br>You will see a page that includes information about the dictionary including the <i>Phones</i> used by it.</li>
  <li>Select and copy the list of phones used by the <i>english_mfa</i> dictionary - i.e. all of these:
  <br><code>a aj aw aÀê b b ≤ c c ∞ d d í d ≤ e ej f f ≤ h i iÀê j k k ∞ l m m ≤ mÃ© n nÃ© o ow p p ∞ p ≤ s t t É t ∞ t ≤ u uÀê v v ≤ w z √¶ √ß √∞ ≈ã …ê …ë …ëÀê …í …íÀê …î …îj …ô …ôw …ö …õ …õÀê …ú …úÀê …ù …ü …° …™ …´ …´Ã© …± …≤ …π …æ  É  â  âÀê  ä  é  í  î Œ∏</code></li>
  <li>Back in the <i>Valid Labels</i> page in LaBB-CAT, paste all of the phone symbols into the box labelled <i>Label</i>
  <br><img src="./forced-alignment/pasted-mfa-labels.png" alt="The Valid Labels form with teh text box filled with all the MFA phoneme symbols"></li>
  <li>Click <i>New</i>.
  <br>You will see that all of the labels are separately added to the list of valid labels.
  <br><img src="./forced-alignment/valid-mfa-labels-list.png" alt="The Valid Labels list is now populated, with each phoneme symbol on a separate line">
  <br>Defining this list for the <i>segment</i> layer means that, when you search the <i>segment</i> layer for specific phones, LaBB-CAT can display a clickable list of possibilities.</li>
  <li>At the bottom of the list, there's a <i>Save</i> button. Click it to save your changes.</li>
  <li>Click the <i>participants</i> option on the menu.</li>
  <li>Find the participant <i>UC207YW</i> and tick their checkbox.</li>
  <li>Click the <i>All Utterances</i> button and then click <i>List</i>.
  <br>You will see a progress bar while all their utterances are identified. Then a results page will be displayed, listing the first 20 utterances.</li>
  <li>Click the <i>Mfa</i> button at the bottom.
  <br>You will see a progress bar appear, while LaBB-CAT gathers the files that MFA needs, runs MFA, and parses the resulting alignments. This will take a few minutes.
  <br>Once it's complete, you can inspect/correct alignments using LaBB-CAT's integration with Praat.</li>
  <li>Go to the <i>transcripts</i> page and open the <i>UC207YW.eaf</i> transcript.</li>
  <li>Tick both the <i>mfa</i> layer and the <i>segment</i> layer.&nbsp;
  <br>You will see which lines have been force-aligned, as they have an MFA timestamp, and have the <i>segment</i> layer filled in.
  <br>
  <br>The interactive transcript page doesn't show you the alignments of the words or phones, but you can see those using Praat. You can open individual utterances in Praat directly from the transcript page, but first, the LaBB-CAT/Praat integration has to be set up; this only has to be done once:</li>
  <li>On the top-right of the page, above the playback controls, there's a Praat icon &nbsp;- click it.</li>
  <li>Follow the instructions that appear (these vary depending on what web browser you use).
  <br>You may be asked whether to allow the ‚ÄúLaBB-CAT Integration Applet‚Äù to run. If you tick the ‚ÄúDo not show this again‚Äù option, then this message will not appear every time you open a transcript.
  <br>You may need to grant a browser extension permission to install, and it's possible you will need a connection to the internet in order to download this extension.
  <br>You also may be asked where Praat is installed; Navigate to the location where Praat is installed, and double-click the ‚ÄúPraat.exe‚Äù file (on some systems the file may simply be called ‚ÄúPraat‚Äù). The Praat program may open, and then immediately close, as LaBB-CAT tests it can communicate with Praat.
  <br>
  <br>Now Praat integration has been set up, and you should be able to access Praat options in the transcript page from now on‚Ä¶</li>
  <li>Click on a line that has been aligned, and select the <i>Open Text Grid in Praat</i> option on the menu.
  <br>You may be asked you if want to allow access to the ‚ÄúLaBB-CAT Integration Applet‚Äù - if so, tick ‚ÄúDo not show this again‚Äù, and click <i>Allow</i>.
  <br>Praat should open, and show you a spectrogram of the line's audio, with a TextGrid below that includes the words and the segments.</li>
  <li>If you click on a word, and hit the <i>&lt;tab&gt;</i> key, the word's interval is played. Try out various words, and see what you think about how accurate HTK has been with its alignment.
  <br>Try this out with different lines in the transcript.
  <br>You will see that in some cases the alignment is pretty good, and in other cases, it's not so good. In the not-so-good cases, see if you can figure out why HTK got it wrong.
  <br>
  <br>You may have noticed that, each time you open an utterance in Praat, a button appears in the transcript to the left of the line, labelled <i>Import Changes</i>. This button allows you to save any adjustments you might want to make to the alignments back into the LaBB-CAT database.</li>
  <li>If you feel confident using Praat, open an utterance TextGrid, adjust the alignments of the words an phones so that they're more accurate, and then click the <i>Import Changes</i> button in the transcript.
  <br>These changes are flagged as manual edits, so if forced-alignment is run again, they will not be over-written with new bad alignments. Therefore it's important that the changes you make are actually improvements, because HTK will never change them again.
  <br>
  <br>There are some rules about what you can change:
 <ol>
  <li>You're not allowed to add or delete words (if this is necessary, it should be done by correcting the transcript instead).</li>
  <li>All the phones must be within the bounds of their own word.</li>
  <li>The start of the first phone should line up with the start of the word, and the end of the last phone should line up with the end of the word.</li>
  <li>You should not change the alignment of the utterance itself (which would only be possible if you select the <i>Open Text Grid incl. ¬± 1 utterance in Praat</i> option).</li></ol></li></ol>
 <p>In this exercise, you have seen how MFA can be used to compute word and phone alignments automatically from your data, and when using a pronunciation dictionary and pre-trained acoustic models, the process is very straightforward.</p>
 <p>Such dictionaries/models are only available for a limited number of languages, but if you have a pronunciation dictionary for the language your corpus uses, MFA can also be used to train its own acoustic models from your corpus, and then use them for forced alignment. This process involves a fair amount of careful transcription, tagging, and dictionary filling.</p>
 <p>Perfect automatic alignments are not guaranteed, but LaBB-CAT has a mechanism for manually correcting poor alignments.</p></article>
      <nav>
        <iframe src="index.html" id="nav" name="nav"></iframe>
      </nav>
    </div>
    <footer><a rel='license' href='http://creativecommons.org/licenses/by-sa/2.0/'><img alt='CC-BY-SA Creative Commons Licence ' src='cc-by-sa.svg' title='This work is licensed under a Creative Commons Attribution-ShareAlike 2.0 Generic License' /></a></footer>
  </body>
</html>
